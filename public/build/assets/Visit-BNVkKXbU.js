import{_ as u}from"./AdminLayout-C89pWBGr.js";import{i as v,j as _,o as c,c as g,w as m,a as o,t as l,e as h,h as f,F as b,f as w,k as x,l as y}from"./app-CiXMtFmy.js";import{_ as k}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./ResponsiveNavLink-BE40vW3e.js";const C={props:["visit"],components:{AdminLayout:u},data(){return{time_passed:0,intervalId:null,photos:[],description:""}},created(){this.startTimer()},beforeDestroy(){clearInterval(this.intervalId)},methods:{startTimer(){const e=new Date(this.visit.visit_started_at);this.intervalId=setInterval(()=>{const r=new Date-e;this.time_passed=this.formatTime(r)},1e3)},formatTime(e){const t=Math.floor(e/1e3),r=Math.floor(t/3600),s=Math.floor(t%3600/60),i=t%60;return`${r}h ${s}m ${i}s`},capturePhoto(){const e=document.createElement("video"),t=document.createElement("canvas"),r=t.getContext("2d");navigator.mediaDevices.getUserMedia({video:!0}).then(s=>{e.srcObject=s,e.play(),e.addEventListener("loadeddata",()=>{t.width=e.videoWidth,t.height=e.videoHeight,r.drawImage(e,0,0,t.width,t.height);const i=t.toDataURL("image/png");this.photos.length<4?this.photos.push({url:i,file:this.dataURLtoFile(i,"photo.png")}):alert("You can upload a maximum of 4 photos."),s.getTracks().forEach(a=>a.stop())})}).catch(s=>{console.error("Error accessing camera:",s)})},dataURLtoFile(e,t){const r=e.split(","),s=r[0].match(/:(.*?);/)[1],i=atob(r[1]),a=i.length,d=new Uint8Array(a);for(;a--;)d[a]=i.charCodeAt(a);return new File([d],t,{type:s})},removePhoto(e){this.photos.splice(e,1)},async endVisit(){navigator.geolocation?navigator.geolocation.getCurrentPosition(async e=>{const{latitude:t,longitude:r}=e.coords;try{const s=new FormData;s.append("visit_id",this.visit.id),s.append("end_latitude",t),s.append("end_longitude",r),s.append("visit_overview",this.description),this.photos.slice(0,4).forEach((a,d)=>{s.append(`photos[${d}]`,a.file)});const i=await v.post(route("merchant.endVisit"),s,{headers:{"Content-Type":"multipart/form-data"}});console.log("Visit ended:",i.data),window.location.href=route("merchant.home")}catch(s){console.error("Error ending visit:",s)}},e=>{console.error("Error getting location:",e)}):console.error("Geolocation is not supported by this browser.")}}},D={class:"font-semibold text-lg text-white leading-tight text-center"},E={class:"max-w-2xl mx-auto"},V={class:"bg-white p-4"},L={class:"text-center text-red-ac text-2xl font-bold"},T={class:"px-3 pt-6"},F=o("h3",{class:"font-bold subtitles"},"Hora Registrada",-1),A={class:"font-medium"},I={class:"px-3 pt-6"},P=o("h3",{class:"font-bold subtitles"},"Tomar Fotos",-1),U={class:"grid grid-cols-2 gap-4"},B=["src"],M=["onClick"],j={key:0,class:"flex items-center justify-center border-2 border-dashed border-gray-300 rounded-lg h-32"},R={class:"px-3 pt-6"},S=o("h3",{class:"font-bold subtitles"},"Bitácora",-1),H={class:"p-4"};function N(e,t,r,s,i,a){const d=_("AdminLayout");return c(),g(d,{title:"Dashboard"},{header:m(()=>[o("h2",D," En Visita - "+l(r.visit.point_of_sale.name)+" - "+l(r.visit.status),1)]),default:m(()=>[o("div",E,[o("div",V,[o("h3",L,l(i.time_passed),1)]),o("div",T,[F,o("p",A,l(new Date(r.visit.visit_started_at).toLocaleTimeString()),1)]),o("div",I,[P,o("div",U,[(c(!0),h(b,null,f(i.photos,(n,p)=>(c(),h("div",{key:p,class:"relative"},[o("img",{src:n.url,alt:"Captured photo",class:"w-full h-32 object-cover rounded-lg"},null,8,B),o("button",{onClick:O=>a.removePhoto(p),class:"absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full"}," × ",8,M)]))),128)),i.photos.length<4?(c(),h("div",j,[o("button",{onClick:t[0]||(t[0]=(...n)=>a.capturePhoto&&a.capturePhoto(...n)),class:"text-gray-500"},"+")])):w("",!0)])]),o("div",R,[S,x(o("textarea",{"onUpdate:modelValue":t[1]||(t[1]=n=>i.description=n),class:"w-full p-2 border rounded-lg",rows:"4",placeholder:"Observaciones (opcional)"},`\r
        `,512),[[y,i.description]])]),o("div",H,[o("button",{type:"submit",onClick:t[2]||(t[2]=(...n)=>a.endVisit&&a.endVisit(...n)),class:"mt-2 bg-red-ac text-white w-full px-4 py-2 rounded-md hover:bg-red-600 transition font-bold"},"Enviar"),o("button",{type:"submit",onClick:t[3]||(t[3]=()=>{}),class:"mt-2 bg-white text-black border border-black w-full px-4 py-2 rounded-md hover:bg-red-600 transition font-bold"},"Cancelar Visita")])])]),_:1})}const z=k(C,[["render",N]]);export{z as default};
